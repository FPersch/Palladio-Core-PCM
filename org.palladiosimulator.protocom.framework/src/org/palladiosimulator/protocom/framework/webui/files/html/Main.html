<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>ProtoCom</title>
		
		<script type="text/javascript" src="/js/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="/js/underscore-1.6.0.min.js"></script>
		
		<link rel="stylesheet" type="text/css" href="/css/style.css">
		
		<script id="template-module" type="text/template">
			<tr data-id="{{- id }}" data-permanent="{{- permanent }}" data-started="false">
				<td>{{- name }}</td>
				<td>
					<button class="action start">Start</button>
				</td>
			</tr>
		</script>
		
		<script type="text/javascript">
			_.templateSettings = {
				interpolate: /\{\{(.+?)\}\}/g, 
				escape: /\{\{-(.+?)\}\}/g
			};
			
			function finishBox() {
				if (typeof this.count == 'undefined') {
					this.count = 0;
				}
				
				this.count++;
				
				if (this.count == 2) {
					$('#main').show();
				}
			}
			
			function updateModule(id, started) {
				var row = $('[data-id="' + id + '"]');
				var permanent = row.data('permanent');
				
				if (permanent) {
					if (started) {
						row.find('.start').hide();
					} else {
						row.find('.start').show();
					}
				}
				
				row.data('started', started);
			}
			
			function updateLog() {
				if (typeof this.logLines == 'undefined') {
					this.logLines = 0;
				}
				
				$.get('/getLog', {'base': logLines}, function(response) {
					var data = response;
					
					if (data.messageCount > 0) {
						var messages = $('#log #messages');
						
						for (var i = 0; i < data.messageCount; i++) {
							if (logLines > 0) messages.append('\n');
							logLines++;
							
							messages.append(data.messages[i]);
						}
						
						messages.scrollTop(messages[0].scrollHeight - messages.height());
					}
				});
			}
			
			$(document).ready(function() {
				$.get('/isRunning', function(response) {
					if (response.running) {
						getModules();
						
						$('#settings').hide();
						$('#modules').show();
						$('#log').show();
					}
					
					$('#main').show();
				});
				
				$('#settings form').submit(function() {
					$.get('/', $(this).serialize(), function(response) {
						if (response.error == 0) {
							getModules();
							
							$('#settings').hide();
							$('#modules').show();
							$('#log').show();
						}
					});
					
					return false;
				});
				
				$('#settings .confirm').click(function() {
					console.log("CONFIRM");
					$('#settings form').submit();
				});
				
				function getModules() {
					$.get('/getModules', function(response) {
						var module = _.template($('#template-module').html());
						var tbody = $('#modules table tbody');
						
						_.each(response, function(element, index, list) {
							tbody.append(module(element));
							updateModule(element.id, element.started);
						});
					});
				}
				
 				updateLog();
				
 				setInterval(function() {
 					updateLog();
 				}, 1000);
				
				$('#modules').on('click', '.start', actionHandler);
				
				function actionHandler(event) {
					var id = $(this).closest('tr').data('id');
					var self = this;
					
					self.disabled = true;
					
					$.get('/startModule', {'id': id}, function(response) {
						updateModule(id, true);
						self.disabled = false;
					});
				}
			});
		</script>
	</head>
	
	<body>
		<div id="main">
			<div id="header">
				<div id="logo"></div>
				<h1>ProtoCom<span class="subtitle">Performance Prototype</span></h1>
			</div>

			<div id="settings" class="box">
				<h2>Settings</h2>
				
				<form>
				<table>
					<col class="name-column">
					<col class="value-column">
					<col class="description-column">

					<thead>
						<tr>
							<th>Name</th>
							<th>Value</th>
							<th>Description</th>
						</tr>
					</thead>

					<tbody>
						<tr>
							<td>Data<span class="required">*</span></td>
							<td><input class="inline" type="text" name="d" spellcheck="false" value="./Data"></td>
							<td class="description">Storage path for sensor data</td>
						</tr>

						<tr>
							<td>Name<span class="required">*</span></td>
							<td><input class="inline" type="text" name="n" spellcheck="false" value="Experiment"></td>
							<td class="description">Name of the experiment</td>
						</tr>

						<tr>
							<td>Thread Count</td>
							<td><input class="inline" type="text" name="c" spellcheck="false"></td>
							<td class="description">Override usage scenario population</td>
						</tr>

						<tr>
							<td>Measurements<span class="required">*</span></td>
							<td><input class="inline" type="text" name="m" spellcheck="false" value="1"></td>
							<td class="description">Maximum measurements to take</td>
						</tr>

						<tr>
							<td>Cycles</td>
							<td><input class="inline" type="text" name="u" spellcheck="false"></td>
							<td class="description">Number of warmup cycles (default: 1000)</td>
						</tr>

						<tr>
							<td>Calibration<span class="required">*</span></td>
							<td><input class="inline" type="text" name="s" spellcheck="false" value="./Calibration"></td>
							<td class="description">Storage path for calibration data</td>
						</tr>

						<tr>
							<td>RMI Address</td>
							<td><input class="inline" type="text" name="R" spellcheck="false"></td>
							<td class="description">Registry address (default: localhost)</td>
						</tr>

						<tr>
							<td>RMI Port</td>
							<td><input class="inline" type="text" name="O" spellcheck="false"></td>
							<td class="description">Registry port (default: 1099)</td>
						</tr>

						<tr>
							<td>Seed</td>
							<td><input class="inline" type="text" name="E" spellcheck="false"></td>
							<td class="description">Seed for the StoEx random generator</td>
						</tr>

						<tr>
							<td>Debug</td>
							<td><input type="checkbox" name="D"></td>
							<td class="description">Print debug information</td>
						</tr>

						<tr>
							<td>Passive</td>
							<td><input type="checkbox" name="P"></td>
							<td class="description">Do not start load drivers, no warmups</td>
						</tr>

						<tr>
							<td>Warmup</td>
							<td><input type="checkbox" name="W"></td>
							<td class="description">Execute warmup runs</td>
						</tr>

						<tr>
							<td>CPU Strategy</td>
							<td>
								<select name="p">
									<option value="primes">Primes</option>
									<option value="count_numbers">Count Numbers</option>
									<option value="fft">FFT</option>
									<option value="fibonacci" selected="selected">Fibonacci</option>
									<option value="mandelbrot">Mandelbrot</option>
									<option value="sortarray">Sort Array</option>
									<option value="void">Void</option>
									<option value="wait">Wait</option>
								</select>
							</td>
							<td class="description">CPU calibration strategy</td>
						</tr>

						<tr>
							<td>HDD Strategy</td>
							<td>
								<select name="H">
									<option value="largeChunks" selected="selected">Large Chunks</option>
								</select>
							</td>
							<td class="description">HDD calibration strategy</td>
						</tr>

						<tr>
							<td>Accuracy</td>
							<td>
								<select name="a">
									<option value="LOW">Low</option>
									<option value="MEDIUM" selected="selected">Medium</option>
									<option value="HIGH">High</option>
								</select>
							</td>
							<td class="description">Accuracy of CPU and HDD calibration</td>
						</tr>
					</tbody>
				</table>
				</form>

				<button class="confirm">Confirm Settings</button>
				<span class="note">Note: Settings cannot be changed after confirmation.</span>
			</div>

			<div id="modules" class="box">
				<h2>Modules</h2>

				<table>
					<col class="name-column">
					<col class="actions-column">

					<thead>
						<tr>
							<th>Name</th>
							<th>Actions</th>
						</tr>
					</thead>

					<tbody>
					</tbody>
				</table>
			</div>

			<div id="log" class="box">
				<h2>Local Log</h2>

				<form>
					<textarea readonly id="messages"></textarea>
				</form>
			</div>
		</div>
	</body>
</html>
