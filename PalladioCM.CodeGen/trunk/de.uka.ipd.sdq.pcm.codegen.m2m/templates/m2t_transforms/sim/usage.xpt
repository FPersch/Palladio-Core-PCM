«EXTENSION m2t_transforms::java_names»
«EXTENSION m2t_transforms::pcm»
«IMPORT system»
«IMPORT core::composition»
«IMPORT usagemodel»
«IMPORT core::entity»
«IMPORT repository»
«IMPORT allocation»

«DEFINE Main FOR UsageModel»
	«FILE "main/SimuComControl.java"»
		package main;
		
		public class SimuComControl extends de.uka.ipd.sdq.simucomframework.AbstractMain 
				implements de.uka.ipd.sdq.simucomframework.ISimuComControl,
				 		   org.osgi.framework.BundleActivator {

				private de.uka.ipd.sdq.simucomframework.ISimuComControl service;
				private org.osgi.framework.ServiceRegistration serviceRegistryEntry;
				
				/*
				 * (non-Javadoc)
				 * @see org.osgi.framework.BundleActivator#start(org.osgi.framework.BundleContext)
				 */
				public void start(org.osgi.framework.BundleContext context) throws Exception {
					service = new SimuComControl();
					
					// register the service
					serviceRegistryEntry = context.registerService(de.uka.ipd.sdq.simucomframework.ISimuComControl.class.getName(), service, new java.util.Hashtable());
				}
				
				/*
				 * (non-Javadoc)
				 * @see org.osgi.framework.BundleActivator#stop(org.osgi.framework.BundleContext)
				 */
				public void stop(org.osgi.framework.BundleContext context) throws Exception {
					serviceRegistryEntry.unregister();
					service = null;
				}
							
			protected de.uka.ipd.sdq.simucomframework.usage.IWorkloadDriver[] getWorkloads() {
				«LET this.usageScenario_UsageModel.querySystemCalls().providedRole_EntryLevelSystemCall.providingEntity_ProvidedRole.uniqueSystemList() AS systemList»
					// Create «systemList.size» System(s)
					«FOREACH systemList AS system»
						«system.fqn()» my«system.javaName()» = new «system.fqn()»();
						«EXPAND UsageScenarioConstructorContextInit FOR system»
					«ENDFOREACH»
				return new de.uka.ipd.sdq.simucomframework.usage.IWorkloadDriver[] {
					«EXPAND WorkloadDriver FOREACH this.usageScenario_UsageModel SEPARATOR ","»
				};
				«ENDLET»
			}
			
			protected de.uka.ipd.sdq.simucomframework.resources.IResourceContainerFactory getResourceContainerFactory(){
				return new ResourceEnvironment();
			}
		}
	«ENDFILE»
«ENDDEFINE»

«DEFINE UsageScenarioConstructorContextInit FOR System»
		«this.fqnContext()» context«this.javaName()» = 
			new «this.fqnContext()»
				(«EXPAND m2t_transforms::usage::DummyRequiredSystemTM(this) FOREACH this.requiredRoles_InterfaceRequiringEntity SEPARATOR ","»);
      	my«this.javaName()».setContext(context«this.javaName()»);
«ENDDEFINE»


«DEFINE UsageScenario(Allocation a) FOR UsageScenario»
	«EXPAND m2t_transforms::sim::usage_factory::UsageScenarioFactory FOR this»
	«FILE this.implementationPackage().fqnToDirectoryPath() + "/" + this.javaName() + ".java"»
		package «this.implementationPackage()»;
		public class «this.javaName()» 
		implements de.uka.ipd.sdq.simucomframework.usage.IScenarioRunner
		{
			«EXPAND m2t_transforms::usage::SystemMemberVar FOREACH this.querySystemCalls().providedRole_EntryLevelSystemCall.toSet()»
			private de.uka.ipd.sdq.simucomframework.Context ctx = null;
			«EXPAND UsageScenarioConstructor(a) FOR this»
			
			«EXPAND ScenarioRunner(this) FOR this.scenarioBehaviour_UsageScenario»
		}
	«ENDFILE»
«ENDDEFINE» 

«DEFINE ScenarioRunner(UsageScenario us) FOR ScenarioBehaviour»
	public void scenarioRunner(de.uka.ipd.sdq.simucomframework.abstractSimEngine.SimProcess thread) {
		ctx.setSimProcess(thread);
		«EXPAND m2t_transforms::sensors::StartResponseTimeMeasurementTM FOR us.entityName.javaString()»
		{
			«EXPAND m2t_transforms::usage::UserActions FOR this.actions_ScenarioBehaviour.typeSelect(Start).get(0)»
		}
		«EXPAND m2t_transforms::sensors::EndResponseTimeMeasurementTM FOR us.entityName.javaString()»
	}
«ENDDEFINE»

«DEFINE WorkloadDriver FOR UsageScenario»
	new «EXPAND WorkloadClass(this) FOR this.workload_UsageScenario»
«ENDDEFINE»

«DEFINE WorkloadClass(UsageScenario u) FOR Workload»
	«ERROR "AbstractWorkload found! This is imposible!"»
«ENDDEFINE»

«DEFINE WorkloadClass(UsageScenario u) FOR ClosedWorkload»
	«LET u.querySystemCalls().providedRole_EntryLevelSystemCall.providingEntity_ProvidedRole.uniqueSystemList() AS systemList»
		de.uka.ipd.sdq.simucomframework.usage.ClosedWorkload(
			new «u.implementationPackage()+"."+u.javaName()+"Factory"»(getModel(),«EXPAND SystemVariableParameter FOREACH systemList SEPARATOR ","»),«this.population»)
	«ENDLET»
«ENDDEFINE»

«DEFINE SystemVariableParameter FOR System»
	my«this.javaName()»
«ENDDEFINE»

«DEFINE SystemVariableDecl FOR System»
	«this.fqn()» my«this.javaName()»
«ENDDEFINE»

«DEFINE WorkloadClass(UsageScenario u) FOR OpenWorkload»
	«LET u.querySystemCalls().providedRole_EntryLevelSystemCall.providingEntity_ProvidedRole.uniqueSystemList() AS systemList»
		de.uka.ipd.sdq.simucomframework.usage.OpenWorkload(getModel(),
			new «u.implementationPackage()+"."+u.javaName()+"Factory"»(getModel(),«EXPAND SystemVariableParameter FOREACH systemList SEPARATOR ","»),
			"«this.interArrivalTime_OpenWorkload.specification.specificationString()»")
	«ENDLET»
«ENDDEFINE»

«DEFINE UsageScenarioConstructor(Allocation a) FOR UsageScenario»
	«LET this.querySystemCalls().providedRole_EntryLevelSystemCall.providingEntity_ProvidedRole.uniqueSystemList() AS systemList»
		public «this.javaName()»(de.uka.ipd.sdq.simucomframework.model.SimuComModel model,«EXPAND SystemVariableDecl FOREACH systemList SEPARATOR ","») {
			ctx = new «a.fqnAllocationContext()»(model);
			ctx.getStack().createAndPushNewStackFrame();
			«EXPAND m2t_transforms::usage::UsageScenarioConstructorContextInit(a) FOR this»
		}
	«ENDLET»
«ENDDEFINE»

